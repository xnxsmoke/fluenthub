-- Fluent & Addons
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local dataRemoteEvent = ReplicatedStorage:WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent")

-- Coordinates
local castleCFrame = CFrame.new(432.6329, 4384.6372, -1898.6741)
local desertCFrame = CFrame.new(463.8988, 4383.7646, -1888.2440)
local bossRushCFrame = CFrame.new(216.035507, 1594.49414, -4315.56738)

-- Flags
local standCastleEnabled, standDesertEnabled = false, false
local autoRestartCastle, autoRestartDesert, autoRestartLabyrinth, autoRestartBossRush = false, false, false, false
local hospRaidEnabled = false
local autoExecHub = _G.autoExecHub ~= false
local selectedBossRushDiff = "Normal"
local minimizedHub = false

-- Helpers
local function safeStandAt(cf)
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = cf
    end
end

local function fireSafe(args)
    pcall(function() dataRemoteEvent:FireServer(unpack(args)) end)
end

local function safeRejoin(joinFunction)
    task.spawn(function()
        local success = false
        for i=1,5 do
            task.wait(math.random(3,6))
            local ok, _ = pcall(joinFunction)
            if ok then success = true break end
        end
    end)
end

-- Modes
local function startCastle()
    fireSafe({ { { Event = "InfiniteCastleAction", Action = "Create" }, "\014" } })
    task.wait(1)
    fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteCastleAction", Action = "Start" }, "\014" } })
    if standCastleEnabled then safeStandAt(castleCFrame) end
end

local function startDesert()
    fireSafe({ { { Event = "InfiniteModeAction", Action = "Create" }, "\014" } })
    task.wait(1)
    fireSafe({ { { Dungeon = 3604563306, Event = "InfiniteModeAction", Action = "Start" }, "\014" } })
    if standDesertEnabled then safeStandAt(desertCFrame) end
end

local function startBossRush()
    fireSafe({ { { Dungeon = 3604563306, Action = "Start", Diff = selectedBossRushDiff, Event = "BossRushAction" }, "\015" } })
    safeStandAt(bossRushCFrame)
end

local function isInHospRaid()
    local ws = game:GetService("Workspace")
    return ws:FindFirstChild("__MAP") or ws:FindFirstChild("RaidBoss")
end

local function joinHospRaid()
    if isInHospRaid() then return end
    fireSafe({ { { Event = "HLRaidAction", Action = "Join" }, "\004" } })
end

-- Create Hub
local hubCreated = false
local function createHub()
    if hubCreated then return end
    hubCreated = true

    local Window = Fluent:CreateWindow({
        Title = "xnxsmoke Hub",
        SubTitle = "by xnxsmoke",
        TabWidth = 160,
        Size = UDim2.fromOffset(580, 460),
        Acrylic = true,
        Theme = "Dark",
        MinimizeKey = Enum.KeyCode.LeftControl
    })

    local Tabs = {
        InfCastle = Window:AddTab({Title="InfCastle"}),
        InfDesert = Window:AddTab({Title="InfDesert"}),
        BossRush = Window:AddTab({Title="BossRush"}),
        HospRaid = Window:AddTab({Title="HospRaid"}),
        Misc = Window:AddTab({Title="Misc"})
    }

    -- InfCastle
    Tabs.InfCastle:AddButton({Title="Start Infinite Castle", Callback=startCastle})
    Tabs.InfCastle:AddToggle("StandCastle",{Title="Stand in the Middle", Default=false}):OnChanged(function(v) standCastleEnabled = v if v then safeStandAt(castleCFrame) end end)
    Tabs.InfCastle:AddToggle("AutoRestartCastle",{Title="Auto-Restart on Portal Destroyed", Default=false}):OnChanged(function(v) autoRestartCastle = v end)

    -- InfDesert
    Tabs.InfDesert:AddButton({Title="Start Infinite Desert", Callback=startDesert})
    Tabs.InfDesert:AddToggle("StandDesert",{Title="Stand in the Middle", Default=false}):OnChanged(function(v) standDesertEnabled = v if v then safeStandAt(desertCFrame) end end)
    Tabs.InfDesert:AddToggle("AutoRestartDesert",{Title="Auto-Restart on Portal Destroyed", Default=false}):OnChanged(function(v) autoRestartDesert = v end)

    -- BossRush
    Tabs.BossRush:AddButton({Title="Start BossRush", Callback=startBossRush})
    Tabs.BossRush:AddDropdown("BossRushDiff",{Title="Difficulty", Values={"Easy","Normal","Hard","Insane"}, Default=2}):OnChanged(function(v) selectedBossRushDiff=v end)
    Tabs.BossRush:AddToggle("AutoRestartBossRush",{Title="Auto-Restart on Rush Ended", Default=false}):OnChanged(function(v) autoRestartBossRush=v end)
    Tabs.BossRush:AddToggle("StandBossRush",{Title="Stand in the Middle", Default=false}):OnChanged(function(v) if v then safeStandAt(bossRushCFrame) end end)

    -- HospRaid
    Tabs.HospRaid:AddToggle("HospRaidAuto",{Title="Auto Join HospRaid", Default=false}):OnChanged(function(v)
        hospRaidEnabled=v
        if v then
            task.spawn(function()
                while hospRaidEnabled do
                    task.wait(3)
                    joinHospRaid()
                end
            end)
        end
    end)

    -- Misc
    Tabs.Misc:AddToggle("AutoExec",{Title="Auto-Execute Hub on Mode Change", Default=autoExecHub}):OnChanged(function(v) autoExecHub=v end)
    Tabs.Misc:AddToggle("MinimizeHub",{Title="Minimize Hub", Default=false}):OnChanged(function(v) minimizedHub=v Window:SetVisible(not v) end)

    SaveManager:SetLibrary(Fluent)
    InterfaceManager:SetLibrary(Fluent)
    SaveManager:IgnoreThemeSettings()
    InterfaceManager:SetFolder("xnxsmokeHub")
    SaveManager:SetFolder("xnxsmokeHub/configs")
    InterfaceManager:BuildInterfaceSection(Tabs.Misc)
    SaveManager:BuildConfigSection(Tabs.Misc)
    Window:SelectTab(1)
    Fluent:Notify({Title="xnxsmoke Hub", Content="Loaded successfully!", Duration=6})
end

if not hubCreated then createHub() end

-- Auto-Exec Loop
task.spawn(function()
    while true do
        task.wait(3)
        if autoExecHub then
            if isInHospRaid() then joinHospRaid()
            else
                local ws = game:GetService("Workspace")
                if ws:FindFirstChild("PortalCastle") then startCastle()
                elseif ws:FindFirstChild("PortalDesert") then startDesert()
                elseif ws:FindFirstChild("BossRushPortal") then startBossRush()
                end
            end
        end
    end
end)

-- Respawn handler
player.CharacterAdded:Connect(function()
    task.wait(0.5)
    if standCastleEnabled then safeStandAt(castleCFrame) end
    if standDesertEnabled then safeStandAt(desertCFrame) end
    if minimizedHub then Fluent:GetWindow():SetVisible(false) end
end)
